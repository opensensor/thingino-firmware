#!/bin/sh

. /usr/share/common

IFACE=wlan0

SDIO_MODULES="8189es 8189fs atbm6031 atbm6031x atbm6062s b43 bcmdhd hi3881 ssv6158"

start() {
	echo_title "Starting wireless interface"

	if [ "true" = "$disable_wlan" ]; then
		echo_error "WLAN disabled"
		exit 1
	fi

	if [ -z "$wlan_module" ]; then
		echo_error "wlan_module is not set"
		exit 1
	fi

	if [ -z "$gpio_wlan" ]; then
		echo_warning "gpio_wlan is not set"
	else
		echo_info "WiFi GPIO: $gpio_wlan"
		for pin_raw in $gpio_wlan; do
			# default to output high
			[ "$pin_raw" = "${pin_raw//[^0-9]/}" ] && pin_raw="${pin_raw}O"

			# extract pin number and suffix
			pin="${pin_raw:0:-1}"
			suffix="${pin_raw:0-1}"

			# convert suffix to binary state
			case "$suffix" in
				o) state=0 ;;
				O) state=1 ;;
				*) echo_warning "Unknown suffix ${suffix}!" ;;
			esac

			echo_info "Set GPIO $pin to $state"
			gpio set "${pin}" "${state}"
		done

		if [ "bcmdhd" = "$wlan_module" ]; then
			echo_info "Unexport GPIO pin $pin"
			gpio unexport $pin
		fi
	fi

	if echo "$SDIO_MODULES" | grep -q "$wlan_module"; then
		echo_info "$wlan_module is an SDIO module"

		# Check if MDIO directory exists
		if [ -d /proc/jz/mdio ]; then
			echo_info "GMAC is enabled, disabling MSC1..."
		else
			case "$SOC_FAMILY" in
				t10 | t20 | t21 | t30)
					echo_info "Skip GPIO setup for $SOC_MODEL"
					# Send INSERT to MMC1 for jzmmc_v12 driver
					echo_info "Send INSERT to MMC1"
					mmc 1
					;;
				t23 | t31)
					if [ "t31a" = "$SOC_MODEL" ]; then
						echo_info "Skip GPIO setup for $SOC_MODEL"
						return 1
					else
						echo_info "Set GPIO pins with /sbin/mmc_gpio"
						/sbin/mmc_gpio
					fi
					# Send INSERT to MMC1 for jzmmc_v12 driver
					echo_info "Send INSERT to MMC1"
					mmc 1
					;;
				t40 | t41)
					echo_info "Skip GPIO setup and manual card detection for $SOC_MODEL (using sdhci-ingenic)"
					# T40/T41 use sdhci-ingenic driver which auto-detects SDIO cards
					;;
				*)
					echo_error "Unsupported SOC type: $SOC_FAMILY"
					exit 1
					;;
			esac
		fi
	else
		echo_warning "MMC1 is not SDIO"
	fi

	if [ -n "$wlan_mac" ] && [ "hi3881" = "$wlan_module" ]; then
		echo_info "Preset MAC address to $wlan_mac in /usr/share/wifi/wifi_cfg"
		sed -i "s/CFG_MAC=[^;]*;/CFG_MAC=$wlan_mac;/" /usr/share/wifi/wifi_cfg
	fi

	if grep -q "^$wlan_module\b" /proc/modules; then
		echo_info "Module $wlan_module is already loaded"
	else
		# For ATBM modules, load cfg80211 first
		if echo "$wlan_module" | grep -q "atbm"; then
			if ! grep -q "^cfg80211\b" /proc/modules; then
				echo_info "Loading cfg80211 module first"
				modprobe cfg80211 || echo_error "Failed to load cfg80211"
			fi
		fi

		echo_info "Loading $wlan_module module with parameters $wlan_module_opts"
		modprobe $wlan_module $wlan_module_opts &
		modprobe_pid=$!

		# Wait for module load with timeout
		timeout=15
		while [ $timeout -gt 0 ]; do
			if grep -q "^$wlan_module\b" /proc/modules; then
				echo_info "Module $wlan_module loaded successfully"
				break
			fi
			if ! kill -0 $modprobe_pid 2>/dev/null; then
				echo_error "modprobe process died unexpectedly"
				break
			fi
			sleep 1
			timeout=$((timeout - 1))
		done

		if [ $timeout -eq 0 ]; then
			echo_error "Module load timed out after 15s, killing modprobe"
			kill -9 $modprobe_pid 2>/dev/null
			exit 1
		fi
	fi

	m=50 # limit to 5 seconds
	while [ "$m" -gt 0 ]; do
		grep -q $IFACE /proc/net/wireless && break
		m=$((m-1))
		sleep 0.1
	done

	if [ "$m" -eq 0 ]; then
		echo_error "Timeout waiting for $IFACE"
		exit 1
	fi

	echo_info "$IFACE is up"
}

stop() {
	echo_title "Stopping wireless interface"

	if grep -q "^$wlan_module\b" /proc/modules; then
		echo_info "Unloading $wlan_module module"
		modprobe -r $wlan_module
	fi
}

case "$1" in
	start)
		start
		;;
	stop)
		stop
		;;
	restart)
		stop
		sleep 1
		start
		;;
	*)
		echo "Usage: $0 {start|stop|restart}"
		exit 1
		;;
esac

exit 0

